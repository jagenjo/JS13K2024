<title>Deep13</title><style>body,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden;background:#000}canvas{background:#000}#DIV{text-align:center;background:rgba(0,0,0,.5);position:fixed;padding:4px;width:100%;top:5px;left:5px;font:24px monospace;color:#aaa}</style><canvas id=C></canvas><div id=DIV>Generating WORLD...please wait</div><script>for(var i in KEYS={},KEYSP={},MOUSE={pos:[0,0],delta:[0,0],wheel:0,buttons:0,prevb:0},gl=0,DOC=document,BODY=DOC.body,F=0,BODY.onkeydown=BODY.onkeyup=function(e){var t="keydown"==e.type,o="Key"==e.code.substr(0,3)?e.code.substr(3):e.code;KEYSP[o]=t&&!KEYS[o],KEYS[o]=t,window.ONKEY&&ONKEY(e)},D2R=.0174532925,maths=Object.getOwnPropertyNames(Math),maths)window[maths[i].toUpperCase()]=Math[maths[i]];function _INITGL(){gl.ext={},gl.getSupportedExtensions().forEach((e=>gl.ext[e]=gl.getExtension(e))),QUAD=MESH(PLANEG),QUADSHADER=PROGRAM(quad_vs,"in vec2 _uv;IN S2D tex;void main(){fragColor=texture(tex,_uv);;}"),FLATSHADER=PROGRAM(_vs,_fs).uniforms({psize:1})}CLAMP=(e,t,o)=>MIN(MAX(e,t),o),SAT=e=>CLAMP(e,0,1),F32=Float32Array,UINT8=Uint8Array,F32P=F32.prototype,IDM4=new F32([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),ARP=Array.prototype,V3=e=>new F32(e||3),M4=e=>V3(e||IDM4),VP_DATA=V3(4),ZERO=V3(),UP=V3([0,1,0]),TIME=()=>.001*performance.now(),LERP=(e,t,o)=>e*(1-o)+t*o,ILERP=(e,t,o)=>(o-e)/(t-e),REMAP=(e,t,o,r,a)=>LERP(r,a,ILERP(t,o,e)),RAND=(e=1,t=0)=>RANDOM()*e+t,FRACT=e=>e-FLOOR(e),ADD=(e,t,o,r=1)=>(e[0]=t[0]+o[0]*r,e[1]=t[1]+o[1]*r,e[2]=t[2]+o[2]*r,e),SUB=(e,t,o)=>(e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e),SCALE=(e,t,o)=>(e=e||V3(),o.length?(e[0]=t[0]*o[0],e[1]=t[1]*o[1],e[2]=t[2]*o[2]):(e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e),DOT=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],CROSS=(e,t,o)=>{var r=t[0],a=t[1],n=t[2],s=o[0],i=o[1],l=o[2];return e[0]=a*l-n*i,e[1]=n*s-r*l,e[2]=r*i-a*s,e},LEN=e=>SQRT(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),ROTY=(e,t,o)=>{e=e||V3();var r=COS(o),a=SIN(o),n=t[0],s=t[2];return e[0]=r*n-a*s,e[1]=t[1],e[2]=a*n+r*s,e},LERPV3=(e,t,o,r)=>{for(var a=0;a<e.length;++a)e[a]=t[a]*(1-r)+o[a]*r;return e},NORM=(e,t)=>{var o=t[0],r=t[1],a=t[2],n=o*o+r*r+a*a;return n>0&&(n=1/SQRT(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e},DIST=(e,t)=>{var o=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return SQRT(o*o+r*r+a*a)},TMAT4=(e,t)=>(e.set(IDM4),e[12]=t[0],e[13]=t[1],e[14]=t[2],e),RMAT4=(e,t,o)=>{e.set(IDM4);var r,a,n,s=o[0],i=o[1],l=o[2],E=SQRT(s*s+i*i+l*l);return E<1e-4?null:(s*=E=1/E,i*=E,l*=E,r=SIN(t),n=1-(a=COS(t)),e[0]=s*s*n+a,e[1]=i*s*n+l*r,e[2]=l*s*n-i*r,e[4]=s*i*n-l*r,e[5]=i*i*n+a,e[6]=l*i*n+s*r,e[8]=s*l*n+i*r,e[9]=i*l*n-s*r,e[10]=l*l*n+a,e)},SMAT4=(e,t)=>((e=e||M4()).set(IDM4),t.toFixed&&(t=[t,t,t]),e[0]=t[0],e[5]=t[1],e[10]=t[2],e),APPLYTRANS=(e,t,o)=>{var r=TMAT4(M4(),o);return MULTMAT4(e||r,t,r)},APPLYROT=(e,t,o,r)=>{var a=RMAT4(M4(),o,r);return MULTMAT4(e||a,t,a)},APPLYSCALE=(e,t,o)=>{var r=SMAT4(M4(),o);return MULTMAT4(e||r,t,r)},COLOR=(e,t=255)=>[e>>16&255,e>>8&255,255&e,t].MUL(1/255),TRS=(e,t,o,r,a)=>{e=e||M4();var n=TMAT4(M4(),t),s=M4();o&&(o[0]&&APPLYROT(s,s,o[0],[1,0,0]),o[1]&&APPLYROT(s,s,o[1],[0,1,0]),o[2]&&APPLYROT(s,s,o[2],[0,0,1]));var i=SMAT4(M4(),r);return MULTMAT4(e,a||M4(),n),MULTMAT4(e,e,s),MULTMAT4(e,e,i)},MULTMAT4=(e,t,o)=>{var r=t[0],a=t[1],n=t[2],s=t[3],i=t[4],l=t[5],E=t[6],S=t[7],A=t[8],P=t[9],f=t[10],L=t[11],R=t[12],T=t[13],v=t[14],D=t[15],I=o[0],p=o[1],c=o[2],N=o[3];return e[0]=I*r+p*i+c*A+N*R,e[1]=I*a+p*l+c*P+N*T,e[2]=I*n+p*E+c*f+N*v,e[3]=I*s+p*S+c*L+N*D,I=o[4],p=o[5],c=o[6],N=o[7],e[4]=I*r+p*i+c*A+N*R,e[5]=I*a+p*l+c*P+N*T,e[6]=I*n+p*E+c*f+N*v,e[7]=I*s+p*S+c*L+N*D,I=o[8],p=o[9],c=o[10],N=o[11],e[8]=I*r+p*i+c*A+N*R,e[9]=I*a+p*l+c*P+N*T,e[10]=I*n+p*E+c*f+N*v,e[11]=I*s+p*S+c*L+N*D,I=o[12],p=o[13],c=o[14],N=o[15],e[12]=I*r+p*i+c*A+N*R,e[13]=I*a+p*l+c*P+N*T,e[14]=I*n+p*E+c*f+N*v,e[15]=I*s+p*S+c*L+N*D,e},LOOKAT=(e,t,o,r)=>{e.set(IDM4);var a=0,n=0,s=0,i=0,l=0,E=0,S=0,A=0,P=0,f=0,L=t[0],R=t[1],T=t[2],v=r[0],D=r[1],I=r[2],p=o[0],c=o[1],N=o[2];return ABS(L-p)<1e-4&&ABS(R-c)<1e-4&&ABS(T-N)<1e-4||(S=L-p,A=R-c,P=T-N,a=D*(P*=f=1/SQRT(S*S+A*A+P*P))-I*(A*=f),n=I*(S*=f)-v*P,s=v*A-D*S,(f=SQRT(a*a+n*n+s*s))?(a*=f=1/f,n*=f,s*=f):(a=0,n=0,s=0),i=A*s-P*n,l=P*a-S*s,E=S*n-A*a,(f=SQRT(i*i+l*l+E*E))?(i*=f=1/f,l*=f,E*=f):(i=0,l=0,E=0),e[0]=a,e[1]=i,e[2]=S,e[4]=n,e[5]=l,e[6]=A,e[8]=s,e[9]=E,e[10]=P,e[12]=-(a*L+n*R+s*T),e[13]=-(i*L+l*R+E*T),e[14]=-(S*L+A*R+P*T)),e},PERSP=(e,t,o,r,a)=>{var n=1/TAN(t*D2R/2),s=0;return e[0]=n/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=a&&a!==1/0?(s=1/(r-a),e[10]=(a+r)*s,e[14]=2*a*r*s):(e[10]=-1,e[14]=-2*r),e},ORTHO=(e,t,o,r,a,n,s)=>{var i=1/(t-o),l=1/(r-a),E=1/(n-s);return e[0]=-2*i,e[5]=-2*l,e[10]=2*E,e[12]=(t+o)*i,e[13]=(a+r)*l,e[14]=(s+n)*E,e},TRANS3D=(e,t,o)=>{var r=t[0],a=t[1],n=t[2],s=o[3]*r+o[7]*a+o[11]*n+o[15];return s=s||1,e[0]=(o[0]*r+o[4]*a+o[8]*n+o[12])/s,e[1]=(o[1]*r+o[5]*a+o[9]*n+o[13])/s,e[2]=(o[2]*r+o[6]*a+o[10]*n+o[14])/s,e},MAT4xV3=(e,t,o,r=1)=>{var a=o[0],n=o[1],s=o[2];return e[0]=t[0]*a+t[4]*n+t[8]*s+t[12]*r,e[1]=t[1]*a+t[5]*n+t[9]*s+t[13]*r,e[2]=t[2]*a+t[6]*n+t[10]*s+t[14]*r,e},VIEW_M4=M4(),PROJ_M4=M4(),VP_M4=M4(),MVP_M4=M4(),CAM_EYE=V3(),CAM_CENTER=V3(),CAM_FRONT=V3(),CAM_RIGHT=V3(),CAM_TOP=V3(),CAMERA=(e,t,o,r,a,n=.1,s=1e3,i=0)=>{CAM_EYE.set(e),CAM_CENTER.set(t),SUB(CAM_FRONT,CAM_CENTER,CAM_EYE),NORM(CAM_FRONT,CAM_FRONT),CROSS(CAM_RIGHT,CAM_FRONT,o),NORM(CAM_RIGHT,CAM_RIGHT),LOOKAT(VIEW_M4,e,t,o),i?ORTHO(PROJ_M4,-r*a,r*a,-r,r,n,s):PERSP(PROJ_M4,r,a,n,s),MULTMAT4(VP_M4,PROJ_M4,VIEW_M4),EXTRACTPLANES(VP_M4)},INIT=e=>{gl||(gl=e.getContext("webgl2",{}),_INITGL()),VIEWPORT(0,0,e.width,e.height)},INPUT=e=>{e.oncontextmenu=e=>!1,e.onmousedown=e.onmouseup=e.onmousemove=e=>{e.preventDefault(),MOUSE.delta[0]=e.pageX-MOUSE.pos[0]+e.movementX,MOUSE.delta[1]=e.pageY-MOUSE.pos[1]+e.movementY,MOUSE.pos[0]=e.pageX,MOUSE.pos[1]=e.pageY,MOUSE.buttons=e.buttons,window.ONMOUSE&&ONMOUSE(e)},BODY.onwheel=e=>MOUSE.wheel=e.deltaY},END=()=>{MOUSE.delta.fill(0),KEYSP={},MOUSE.wheel=0,MOUSE.prevb=MOUSE.buttons},VIEWPORT=(e,t,o,r)=>{VP_DATA.set([e,t,o,r]),gl.viewport(e,t,o,r)},SHADER=(e,t=0)=>{var o=gl.createShader(35632+t);if(gl.shaderSource(o,"#version 300 es\nprecision highp float;\n#define IN uniform\n#define S2D sampler2D\n#define NORM normalize\nin vec3 pos;\n"+(t?"":"out vec4 fragColor;\n")+e),gl.compileShader(o),!gl.getShaderParameter(o,gl.COMPILE_STATUS)){throw`Could not compile WebGL program. \n\n${gl.getShaderInfoLog(o)}`}return o},_vs="in vec2 uv;out vec2 _uv;IN float psize;IN mat4 viewp;IN mat4 model;void main(){_uv=uv;gl_Position = viewp*model*vec4(pos,1.0);gl_PointSize=psize;;}",_fs="IN vec4 color;void main(){fragColor=color;;}",_texfs="IN S2D tex;IN vec4 color;void main(){fragColor=color*texture(tex,_uv);;}",quad_vs="out vec2 _uv;void main(){ _uv=pos.xy*0.5+vec2(0.5);gl_Position=vec4(pos,1.0);;}",UNIFUNCS={5124:"1i",5125:"1ui",5126:"1f",35664:"2fv",35665:"3fv",35666:"4fv",35676:"Matrix4fv",35678:"1i"},PROGRAM=(e=_vs,t=_fs,o=[])=>{var r,a,n=o.map((e=>"#define "+e)).join("\n"),s=gl.createProgram(),i=gl.getProgramParameter.bind(gl);for(gl.attachShader(s,SHADER(n+e,1)),gl.attachShader(s,SHADER(n+t)),gl.linkProgram(s),s.unif={},s.attr={},r=0,a=i(s,35718);r<a;++r){var l=(E=gl.getActiveUniform(s,r)).name;l=l.substr(0,l.length-(E.size>1?3:0)),(s.unif[l]=E).loc=gl.getUniformLocation(s,l),E.func=gl["uniform"+UNIFUNCS[E.type]].bind(gl),E.set=35676==E.type?function(e){this.func(this.loc,!1,e)}:function(e){this.func(this.loc,e)}}for(r=0,a=i(s,35721);r<a;++r){var E=gl.getActiveAttrib(s,r);(s.attr[E.name]=E).loc=r}return s.bind=()=>gl.useProgram(s),s.uniforms=e=>{if(s.bind(),e)for(var t in e)s.unif[t]?.set(e[t]);return s},s.set=(e,t)=>s.unif[e]?.set(t),s},BUFFER=(e,t=3,o=35044)=>{var r=gl.createBuffer(),a=34962+(t?0:1);return e.constructor==Array&&(e=t?V3(e):new Uint16Array(e)),r.b=()=>gl.bindBuffer(a,r),r.update=e=>(e&&r.d.set(e),r.b(),gl.bufferData(a,r.d,o),r),r.bind=(e,o=0)=>{r.b(),null!=e&&(gl.vertexAttribPointer(e,t,5126,!1,0,0),gl.enableVertexAttribArray(e),gl.vertexAttribDivisor(e,o))},r.map=function(e){this.update(this.d.map(e))},r.size=e.length,r.num=t,r.d=e,r.b(),gl.bufferData(a,r.d,o),r},MESH=e=>{var t={};for(var o in e)e[o]&&(t[o]=BUFFER(e[o],"tris"==o?0:o.length));return t[0]=t.tris?t.tris.size:t.pos.size/3,t},TEX=(e,t,o=null,r=0)=>{var a,n=gl.createTexture();for(n.w=0|e,n.h=0|t,n.bind=(e=0)=>(gl.activeTexture(33984+e),gl.bindTexture(3553,n),n),n.param=(e,t)=>(n.bind(),gl.texParameteri(3553,10240+e,t),n),n.toVP=(e,t)=>{n.bind(),DRAW(QUAD,e||QUADSHADER,t||{tex:0})},n.mips=()=>{n.bind(),gl.generateMipmap(3553)},(n.update=o=>(n.bind(),gl.texImage2D(3553,0,r?33190:6408,0|e,0|t,0,r?6402:6408,r?5125:5121,o)))(o),a=0;a<4;++a)n.param(a,[9729,33071][a/2|0]);return n},FBO=(e,t)=>{var o=gl.createFramebuffer();o.tex=e;var r=o.w=e.w,a=o.h=e.h;return gl.bindFramebuffer(36160,o),gl.framebufferTexture2D(36009,36064,3553,e,0),o.depth=t||TEX(r,a,null,1),gl.framebufferTexture2D(36009,36096,3553,o.depth,0),o.bind=e=>(gl.bindFramebuffer(36160,e?o:null),VIEWPORT(0,0,e?r:C.width,e?a:C.height),o),o.bind(0),o},GLSET=(e,t=1)=>t?gl.enable(e):gl.disable(e),CLEAR=(e,t)=>{e&&gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear((e?16384:0)|(t?256:0))},CULL=2884,ZTEST=2929,BLEND=3042,NEAREST=9728,LINEAR=9729,blendf={A:[770,771],B:[770,1]},BLENDFUNC=e=>{var t=blendf[e];gl.blendFunc(t[0],t[1]),GLSET(BLEND,1)},DEPTHW=(e=1)=>gl.depthMask(e),PLANE=(e=1)=>MESH({pos:[-e,0,-e,e,0,e,e,0,-e,e,0,e,-e,0,-e,-e,0,e],uv:[0,0,1,1,1,0,1,1,0,0,0,1]}),PLANEG={pos:[-1,-1,0,1,-1,0,1,1,0,-1,1,0],tris:[0,1,2,0,2,3]},QUAD=0,QUADSHADER=0,FLATSHADER=0,meshes={},DRAW=(e,t,o,r=4,a=1,n=0)=>{if(e&&e.length&&(e=meshes[e]),e&&e[0]){for(var s in(t=t||FLATSHADER).bind(),t.unif.viewp?.set(VP_M4),t.unif.ceye?.set(CAM_EYE),t.unif.cfront?.set(CAM_FRONT),t.uniforms(o),e)e[s].bind&&e[s].bind(t.attr[s]?.loc);if(n)for(var s in n)n[s].bind(t.attr[s].loc,1);e.tris?gl.drawElementsInstanced(r,e[0],5123,0,a):gl.drawArraysInstanced(r,0,e[0],a)}},EXTRACTPLANES=e=>{FPLANES=[];for(var t=0;t<6;++t){var o=t%2?1:-1,r=t>>1,a=V3([e[3]+o*e[r],e[7]+o*e[4+r],e[11]+o*e[8+r],e[15]+o*e[12+r]]),n=LEN(a);n||(n=1e-4);for(r=0;r<4;++r)a[r]/=n;FPLANES.push(a)}},PLANEOVERLAP=(e,t,o)=>{var r=ABS(o[0]*e[0])+ABS(o[1]*e[1])+ABS(o[2]*e[2]),a=DOT(e,t)+e[3];return a<=-r?0:a<=r?1:2},CAMTESTBOX=(e,t)=>{for(var o,r=0,a=0;a<6;++a){if(!(o=PLANEOVERLAP(FPLANES[a],e,t)))return 0;r+=2==o?1:0}return r?1:2};var ox,oy,oz,vs=`\nIN mat4 model;\nIN mat4 viewp;\nIN vec3 ceye;\nIN float time;\nIN vec4 color;\n#ifdef INST\nIN float scale;\nin vec4 offs;\n#endif\nout vec3 wpos;\nout vec4 vcol;\nvec3 ROTY(vec3 v,float a){vec2 t=vec2(sin(a),cos(a));return vec3(t.y*v.x-t.x*v.z,v.y,t.x*v.x+t.y*v.z);}\nfloat PI=${PI};\nvoid main(){\nwpos=pos;\nvcol=color;\nfloat id=float(gl_InstanceID);\n#ifdef INST\nwpos=ROTY(wpos,id);\nwpos*=offs.w*scale;\nwpos+=offs.xyz;\nvcol.xyz+=vec3(sin(wpos.y*0.2+wpos.z*0.3+wpos.x*0.1+cos(wpos.x*0.1)*0.5))*0.1;\n#endif\nwpos=(model*vec4(wpos,1.0)).xyz;\ngl_PointSize=(sin(float(gl_VertexID))*0.5+1.2);\ngl_Position=viewp*vec4(wpos,1.0);\n}\n`,fs="\nin vec3 wpos;\nin vec4 vcol;\nIN vec3 ceye;\nIN vec3 cfront;\nIN float spot;\nIN vec3 target;\nIN vec3 flare;\nvec3 scolor=vec3(.04,.06,.07);\nvec3 fcolor=vec3(.2,.5,.8);\nIN float time;\nIN float mat;\nIN vec4 emis;\nvoid main(){\nvec3 L=vec3(0,1,0);\nvec3 E=wpos-ceye;\nfloat dist = length(E);\nE/=dist;\n#ifdef POINTS\nvec3 N=-E;\n#else\nvec3 N=NORM(cross(dFdx(wpos),dFdy(wpos)));\n#endif\nvec4 C=vcol;\n#ifndef POINTS\nvec3 light = fcolor*max(0.0,(wpos.y-44.0)/20.0) * max(0.0,0.5 + 0.5 * (N.y+1.0)/2.0);//sky\nfloat fog = pow(clamp(dist/150.0,0.0,1.0),0.3);\nfloat spotatt = max(0.0,1.0 - clamp(dist/40.0,0.0,2.0));\nvec3 F=(cfront+vec3(0.0,-0.1,0.0));\nlight += vec3(0.6,0.7,0.8)*(dot(N,-F)*0.25+0.75)*smoothstep(0.92,0.99,max(0.0,dot(F,E)))*spotatt*spot;\nC.xyz=mix(C.xyz*light,scolor,fog);\nC.xyz+=vec3(0.2,0.5,0.3)*pow(clamp(1.0 - length(target-wpos)/15.0,0.0,1.0),2.5);\nC.xyz+=vec3(1.2,0.3,0.1)*pow(clamp(1.0 - length(flare-wpos)/5.0,0.0,1.0),2.5);\n#else\nC.a /= dist*1.2;\n#endif\nfragColor=C+emis;\n}\n",fx_fs="in vec2 _uv;IN S2D tex;IN S2D texB;IN float R;vec2 barrel(vec2 uv,float v){vec2 st=uv-0.5;float t=atan(st.x,st.y);float r=sqrt(dot(st,st));r*=1.0+v*(r*r);return 0.5+r*vec2(sin(t),cos(t));}\nvoid main(){\n    vec2 uv=_uv+(texture(texB,_uv).xy-vec2(0.5))*0.04;\n    float l=length(_uv-vec2(0.5));\n    if(l>R)discard;\n    if(l>R*0.98)fragColor=vec4(0.1);\n    else{\n    float vig=pow(1.0-l/0.45,0.5);\n    fragColor=vig*(texture(tex,barrel(uv,-1.2),2.0)*0.5+texture(tex,barrel(uv,-1.2),4.0)*0.5+texture(tex,barrel(uv,-1.2))*1.5);;}\n    }\n",final_fs="in vec2 _uv;IN S2D tex;IN float D;IN float V;IN float time;\nvoid main(){\n    float l=_uv.y+0.1*round(10.0*sin(_uv.x+time)*cos(_uv.x*0.3+time*1.2))*0.1;\n    vec4 C=texture(tex,_uv+vec2(0.0,l<D?sin(time*2.0)*0.01:0.0),l<D?3.0:0.0);\n    if(l<D){C.xy*=0.8;C.xyz+=vec3(l-D)*0.2;}\n    fragColor=C*V;;}\n",DEBUG=0,j=(i=0,0),k=0;ARP.p=ARP.push,SIM=(e,t,o)=>{l=e.length/3;for(var r=0,a=t.length;r<a;r+=3)t.p(t[r]+l,t[r+2]+l,t[r+1]+l);e.p(...e.map(((e,t)=>e*o[t%3])))},FETCH=(e,t)=>fetch(e).then((e=>e.arrayBuffer())).then(t),LOAD=(e,t,o,r,a)=>FETCH(e+".xbin",(o=>{for(var r,a=new Int8Array(o),n=new UINT8(o),s=[],i=n[0],l=1;l<=3*i;l+=3)s.p(a[l]/127,n[l+2]/255-.5,a[l+1]/127);r=Array.from(n.subarray(3*i+2)),t&&SIM(s,r,[-1,1,1]);meshes[e]=MESH({pos:s,tris:r})}));var fbo,fboView,fboSonar,fcolor=[.2,.5,.8,1],scolor=[.04,.06,.07,1],NOW=0,PREV=0,GTIME=0,STIME=5,V4=[0,0,0,0];INPUT(C),INIT(C),sh=PROGRAM(vs,fs).uniforms({emis:V4}),sh_inst=PROGRAM(vs,fs,["INST"]),sh_points=PROGRAM(vs,fs,["POINTS"]),sh_sonar=PROGRAM("IN float time;IN vec3 ceye;IN mat4 viewp;IN mat4 model;out vec2 dist;void main(){vec4 p=model*vec4(pos,1.0);gl_Position=viewp*p;dist=vec2(length(p.xyz-ceye),sin(float(gl_VertexID)+time*10.0)*0.5+0.5);gl_PointSize=3.0;;}","in vec2 dist;IN vec4 color;void main(){fragColor=color*dist.y;;}"),sh_fx=PROGRAM(quad_vs,fx_fs),sh_final=PROGRAM(quad_vs,final_fs),meshes.plane=PLANE(),LOAD("head",1),NSIN=e=>SIN(2*e*PI);var SEED=30;HASH3D=(e,t,o)=>(e=50*FRACT(.3183099*e+.71),t=50*FRACT(.3183099*t+.113),o=50*FRACT(.3183099*o-.247),2*FRACT(1.375986*SEED+e*t*o*(e+t+o))-1),NOISE3D=(e,t,o)=>{let r=FLOOR(e),a=FLOOR(t),n=FLOOR(o),s=FRACT(e),i=FRACT(t),l=FRACT(o),E=s*s*(3-2*s);return LERP(LERP(LERP(HASH3D(r,a,n),HASH3D(r+1,a,n),E),LERP(HASH3D(r,a+1,n),HASH3D(r+1,a+1,n),E),i*i*(3-2*i)),LERP(LERP(HASH3D(r,a,n+1),HASH3D(r+1,a,n+1),E),LERP(HASH3D(r,a+1,n+1),HASH3D(r+1,a+1,n+1),E),i*i*(3-2*i)),l*l*(3-2*l))};var WSIZE=512,BSIZE=64,HSIZE=BSIZE+20,MAPDOTS=[],WORLD=0,BLOCKS=[];GENWORLD=()=>{GEN=(e,t,o)=>!t||!e||!o||e==WSIZE-1||o==WSIZE-1||NOISE3D(.1*e,.1*t-20,.1*o)+ABS(.005*(e-WSIZE/2))-1.3*SAT(1-LEN([224,4,348])/30)>0?1:0,WORLD=new UINT8(WSIZE*WSIZE*HSIZE);var e=new UINT8(WORLD);for(GETW=(e,t,o)=>t>=HSIZE?0:WORLD[(0|e)+(0|t)*WSIZE+WSIZE*HSIZE*(0|o)],SETW=(e,t,o,r)=>WORLD[e+t*WSIZE+o*(WSIZE*HSIZE)]=r,SETW2=(t,o,r,a)=>e[t+o*WSIZE+r*(WSIZE*HSIZE)]=a,x=0;x<WSIZE;x++)for(z=0;z<WSIZE;z++){let e=5*(NOISE3D(.02*x,0,.03*z)+1);for(y=0;y<HSIZE-e;y++)SETW(x,y,z,GEN(x,y,z))&&RAND()<.3&&MAPDOTS.push(x,y,z)}new UINT8(WORLD.length);for(e.set(WORLD),x=1;x<WSIZE-1;x++)for(y=1;y<HSIZE-1;y++)for(z=1;z<WSIZE-1;z++)GETW(x,y,z)&&GETW(x-1,y,z)&&GETW(x+1,y,z)&&GETW(x,y-1,z)&&GETW(x,y+1,z)&&GETW(x,y,z-1)&&GETW(x,y,z+1)&&SETW2(x,y,z,2);for(WORLD.set(e),CREATEBLOCK=(e,t)=>{var o=new F32(BSIZE*BSIZE*HSIZE*4),r=0;for(x=0;x<BSIZE;x++)for(y=0;y<HSIZE;y++)for(z=0;z<BSIZE;z++)1==GETW(x+e,y,z+t)&&(o.set([x+e+RAND(0),y+RAND(0,-1),z+t+RAND(0),2.2+RAND()],4*r),r++);BLOCKS.push({num:r,pos:[e+BSIZE/2,HSIZE/2,t+BSIZE/2],insts:BUFFER(o.subarray(0,4*r),4)})},GSIZE=WSIZE/BSIZE,i=0;i<GSIZE*GSIZE;i++)CREATEBLOCK(i%GSIZE*BSIZE,FLOOR(i/GSIZE)*BSIZE);MAPDOTS=BUFFER(MAPDOTS,3)},PBUFFER=BUFFER(new F32(768),3),PBUFFER.map((()=>RAND(8))),DBUFFER=BUFFER(new F32(30720),3,35048);var DMG=[],ADDPART=e=>DMG.length<10240?DMG.push({p:e,v:SUB(V3(),[RAND(.2,.4),RAND(-.2),0],e),t:3}):0,WPs=[[228,19,364],[247,29,371],[239,37,385],[245,39,398],[258,50,400],[271,61,399],[260,69,381],[261,84,357],[272,93,421],[290,73,391],[297,60,376],[288,51,369],[288,40,369],[277,40,361],[264,48,360],[240,50,359],[232,41,360],[237,32,360],[234,20,362]],start=[WSIZE/2,1.5*HSIZE,WSIZE/4],targets=[[182,20,329],[298,22,271]],flares=[[255,82,319],[219,81,218]],TRG=V3(),FLR=V3();TRGdist=1e3,sonarbeep=0,out=0,WPBUFFER=BUFFER(WPs.flat(),3);var HMODEL=M4(),AMODEL=M4(),UItex=0,level=0,isInside=0,signal=.1,totarget=V3(),spark=0,nrg=0,batt=0,shake=0,boom=0,gear=0;PLY=0;var SNK={pos:V3(WPs[0]),index:0,ang:0,call:4,dist:1e4,tail:0};for(SNK.tail=BUFFER(new F32(200),4),SNK.part=e=>SNK.tail.d.subarray(4*e,4*e+3),i=1;i<50;++i)SNK.tail.d.set([SNK.pos[0]+i,SNK.pos[1],SNK.pos[2]+5,LERP(1.5,.2,i/50)],4*i);SNK.tail.update(),NEWCANVAS=()=>document.createElement("canvas").getContext("2d");let UIctx=NEWCANVAS(),GLASSctx=NEWCANVAS(),GLASS=0;GLASSctx.canvas.width=GLASSctx.canvas.height=512,GLASS=TEX(512,512,GLASSctx.canvas);var ACX,ADEST,AVOL,asea,abeep,asnk,asonar,ashake,INRANGE=(e,t,o)=>e>=t&&e<o;let gradient;BREAKGLASS=e=>{let t=GLASSctx;if(e)GLASSctx.fillStyle="#777",GLASSctx.fillRect(0,0,512,512);else{for(t.save(),t.globalCompositeOperation="difference",t.strokeStyle="#111",t.fillStyle="#"+(0|RAND(16)).toString(16)+(0|RAND(16)).toString(16)+"0",t.beginPath(),t.moveTo(RAND(1e3,-100),RAND(1e3,-100)),i=0;i<5;++i)t.lineTo(RAND(512),RAND(512));t.fill(),t.stroke(),t.restore()}GLASS.update(GLASSctx.canvas),GLASS.mips()},BREAKGLASS(1),RESET=()=>{PLY={pos:V3(start),ang:0,nrg:1,spot:2,sonar:100,scan:1,hasTRG:0,vel:V3(),dmg:.1,open:0,life:1.1,batt:1,speed:[0,0,0]},P=PLY.pos,TRG=V3(targets[level]),FLR=V3(flares[level]),DIV.style.fontSize="",BREAKGLASS(1)},RESET(),CHANNEL=()=>{var e=ACX.createOscillator(),t=ACX.createBufferSource(),o=ACX.createBiquadFilter(),r=ACX.createGain();e.frequency.value=0,t.buffer=BUF,t.loop=!0,o.frequency.value=1e4,r.gain.value=0,e.connect(r),t.connect(o),o.connect(r),r.connect(AVOL);var a={osc:e,noise:t,filter:o,gain:r,volume:e=>r.gain.linearRampToValueAtTime(SAT(e),ACX.currentTime+.1),freq:t=>e.frequency.value=t};return a},STARTAUDIO=()=>{ACX=new AudioContext,ADEST=ACX.destination,(AVOL=ACX.createGain()).gain.value=.5,AVOL.connect(ADEST);var e=2*ACX.sampleRate;BUF=ACX.createBuffer(1,e,ACX.sampleRate),data=BUF.getChannelData(0);for(var t=0;t<e;t++)data[t]=2*RANDOM()-1;asea=CHANNEL(),abeep=CHANNEL(),asnk=CHANNEL(),asonar=CHANNEL(),ashake=CHANNEL(),asea.noise.start(),asea.filter.Q.value=15,abeep.osc.start(),asnk.osc.start(),asonar.noise.start(),ashake.osc.start()};var eye=V3(),target=V3(),front=V3(),IMP=V3();CAM_EYE.set([180,5,-250]),loop=()=>{requestAnimationFrame(loop),WORLD||GENWORLD(),NOW=TIME();var e=MIN(.1,NOW-PREV);PREV=NOW;var t=C.width=BODY.offsetWidth,o=C.height=BODY.offsetHeight,r=t>>2,a=o>>2;fbo&&fbo.h==a&&fbo.w==r||(fbo=FBO(TEX(r,a).param(0,NEAREST).param(1,9984))),fboView&&fboView.h==a||(fboView=FBO(TEX(a,a).param(0,NEAREST).param(1,9987))),(!fboSonar||fboSonar.tex.h!=a|0)&&(fboSonar=FBO(TEX(a,a).param(0,NEAREST))),GTIME+=e,STIME-=e,sonarbeep=RAND()<.03+.5*SAT(1-TRGdist/100)?1:0,out=P[1]>2*HSIZE?1:0;let n="Explore the depths, find the origin of the signal "+(ACX?"":"(Click for audio)");if(PLY.won?n="Mission Accomplished, Time: "+(0|PLY.time)+"s":PLY.life<=0?n="You drowned, press SPACE to restart":PLY.open>0?n="FIX LEAK, press G multiple times!!":PLY.hasTRG&&(n="Carry it to the surface!"),DIV.innerText=n,ACX){asea.filter.frequency.value=(PLY.open>0?400:0)+out?1600:100+P[1]+ABS(PLY.speed[2]),asea.volume(out?.3*SIN(GTIME)+.4:.9),abeep.volume(PLY.scan*signal/2),abeep.freq(440*sonarbeep);let e=FRACT(GTIME/SNK.call+.1*RAND());asnk.volume(1-e-SAT(SNK.dist/50)),asnk.freq(120-50*POW(e,.15)+0*e*SIN(10*GTIME*e)),e=FRACT(GTIME/2),asonar.volume(PLY.sonar?.1*POW(1-e,2):0),asonar.filter.frequency.value=800-200*e,asonar.filter.Q.value=30+5*RAND(),ashake.volume(SAT(10*(shake+boom))),ashake.freq(RAND(140,50))}let s,E=UIctx,S=E.canvas,A=a/7;for(E.imageSmoothingEnabled=!1,S.width=r,S.height=a,E.textAlign="center",E.font=(.2*A|0)+"px monospace",E.translate(0,a),E.scale(1,-1),FCOLOR=e=>E.strokeStyle=E.fillStyle=e,RECT=(e,t,o,r,a)=>{FCOLOR(a),E.fillRect(e,t,o,r)},CIRCLE=(e,t,o,r)=>{r&&FCOLOR(r),E.beginPath(),E.arc(e,t,o,0,2*PI),E.fill()},DIAL=(e,t,o,r,a,n,s=5,i=0)=>{CIRCLE(t,o,r+2,"#333"),CIRCLE(t,o,r,"#000"),E.save(),E.translate(t,o),FCOLOR("#4A6"),E.fillText(e||"",0,r/1.5),E.rotate(PI/2-(2==i?2*n*PI-PI/2:.95)),E.save(),FCOLOR("#620"),1==i&&(E.beginPath(),E.moveTo(0,0),E.arc(0,0,.9*r,0,.3),E.fill(),CIRCLE(0,0,.35*r,"#000")),FCOLOR("#0A4");for(let e=0;e<a+1;++e)E.fillRect(-1,.8*r,e%s?.5:2,4),e%s==0&&3!=i&&E.fillText(2==i?"ENESW"[e/s]:e,0,.7*r),E.rotate(2*PI*(2==i?1:.8)/a);E.restore(),E.rotate(2*SAT(n)*PI*(2==i?1:.8)),FCOLOR("#4C8"),E.fillRect(-1,0,2,.9*r),CIRCLE(0,0,.05*r),E.restore()},RECT(0,0,r,a,"#111"),FCOLOR("#ccc"),E.fillText("by TAMAT",r-20,a-4),E.save(),E.translate(r/2-a/1.5,0),i=0;i<4;++i)RECT(a*-[.12,.06,.04,.02][i],0,.2*a/(i+1),a,["#000","#222","#333","#444"][i]);DIAL("BATT",0,a-1.1*A,A,30,batt);let f=1-SAT(P[1]/170);for(DIAL("ATM",0,A+10,A,14,f+RAND(.2*SAT(f-.8)),1,1),gear=LERP(PLY.open,gear,.99),E.translate(0,a/2),CIRCLE(0,0,8,"#111"),E.rotate(10*gear),j=0;j<3;++j){for(E.lineWidth=3-j,E.strokeStyle=["#210","#371911","#520"][j],E.beginPath(),i=0;i<8;++i)E.rotate(2*PI/8),E.moveTo(0,0),E.lineTo(-8.5,19),E.lineTo(7,20);E.stroke()}if(CIRCLE(0,0,3,"#111"),E.restore(),s=PLY.ang/(2*PI)%1,DIAL(0,r/2+a/1.3-A,a/1.8,.75*A,8,1-(s+(s<0?1:0)),2,2),DIAL("TANK",r/2-a/2.25,.1*a,.5*A,2,PLY.speed[1]/32+.5,.5,3),nrg=LERP(PLY.nrg/20,nrg,.99),DIAL("KWh",r/2-a/2.32,.9*a,.5*A,15,nrg+.02*SIN(GTIME),15,3),DIAL("AIR",r/2-a/1.8,.65*a,.4*A,15,PLY.life,15,3),E.save(),E.translate(r/2+a/1.7,a-1.1*A),CIRCLE(0,0,A+2,"#222"),CIRCLE(0,0,A,"#000"),PLY.scan){for(E.strokeStyle="#0F0",E.beginPath(),E.moveTo(0,0),i=0;i<1.5*A;++i)E.lineTo(i-.75*A,(RAND(4,-2)+sonarbeep*signal*RAND(A,-A/2)+spark*RAND(30,-15))*NSIN(i/A*.34));E.stroke(),E.restore()}for(UItex&&UItex.w==r&&UItex.h==a?UItex.update(S):UItex=TEX(r,a,S),UItex.param(0,9728),INIT(C),fboView.bind(1),CLEAR(scolor,1),front[0]=SIN(PLY.ang),front[2]=COS(PLY.ang),ADD(eye,P,[.1*SIN(GTIME),RAND(.1)*isInside,.1*COS(.97*GTIME)]),ADD(target,eye,front),i=0;i<3;++i)target[i]+=RAND(shake);for(b of(CAMERA(eye,target,UP,80,1,.1,150),GLSET(ZTEST),GLSET(CULL,0),GLSET(BLEND,0),DRAW("plane",sh,{emis:V4,spot:0,target:[0,-1e3,0],color:[0,0,0,1],model:TRS(HMODEL,[eye[0],2*HSIZE,eye[2]],0,1e3)}),GLSET(CULL,1),BLOCKS))CAMTESTBOX(b.pos,[BSIZE,HSIZE,BSIZE])&&DRAW("head",sh_inst,{color:[.5,.6,.7,.1],target:TRG,flare:FLR,scale:1,emis:V4,spot:PLY.spot,model:AMODEL},4,b.num,{offs:b.insts});for(PLY.hasTRG&&ADD(TRG,eye,[front[0],front[1]-.7,front[2]],.75),DRAW("head",sh,{color:[.1,.1,.1,1],emis:[.2,.5,.3,0],spot:2*PLY.spot,model:TRS(HMODEL,TRG,0,1)}),DRAW("head",sh,{color:[.1,.1,.1,1],emis:[RAND(),RAND(.3),0,0],model:TRS(HMODEL,FLR,0,.2)}),BLENDFUNC("A"),i=0;i<4;++i)DRAW("head",sh_inst,{color:[.1,.1,.1,.2],scale:.5+i/4,emis:!i&&spark?[0,1,3,0]:[-.02,-.02,-.02,0],spot:2*PLY.spot,model:AMODEL},5,50,{offs:SNK.tail});if(!out)for(i=-2;i<=2;++i)for(j=-1;j<=1;++j)for(k=-2;k<=2;++k)DRAW({pos:PBUFFER,0:256},sh_points,{color:[.7,.8,.9,.3],emis:V4,model:TRS(HMODEL,[8*ROUND(P[0]/8+i),8*ROUND(P[1]/8+j),8*ROUND(P[2]/8+k)],0,1)},0);if(DEBUG&&WPs.length&&DRAW({pos:WPBUFFER,0:WPs.length},0,{color:[1,1,1,1],model:AMODEL},3),sh.uniforms({time:GTIME}),GLSET(ZTEST,0),GLSET(BLEND,0),fboView.bind(0),fboView.tex.mips(),fboSonar.bind(1),CLEAR(V4),ADD(target,P,[-front[2],front[1],front[0]],PLY.sonar),CAMERA(target,P,UP,60,1,PLY.sonar-3,PLY.sonar+3),GLSET(ZTEST,0),BLENDFUNC("B"),PLY.sonar&&(DRAW({pos:MAPDOTS,0:MAPDOTS.d.length/3},sh_sonar,{model:AMODEL,time:GTIME,ceye:P,color:[.02,1,.07,.4],model:AMODEL},0),DRAW("head",sh,{color:[0,0,0,1],emis:[0,1,.1,0],spot:0,model:TRS(HMODEL,ADD(V3(),P,[0,-1,0]),[0,PLY.ang],[8,4,8])},4),DRAW("head",sh_inst,{color:[.1,.1,.1,.5],scale:2,emis:[1,.3,0,0],spot:0,model:AMODEL},5,18,{offs:SNK.tail}),DRAW("head",sh,{emis:[.1,.5,1,0],model:TRS(HMODEL,TRG,0,2)})),GLSET(CULL,0),fboSonar.bind(0),fboSonar.tex.mips(),fbo.bind(1),GLSET(BLEND,1),BLENDFUNC("A"),UItex.toVP(),GLSET(BLEND,0),VIEWPORT(r/2-a/2,0,a,a),GLASS.bind(1),fboView.tex.toVP(sh_fx,{R:.5,texB:1}),VIEWPORT(r/2+a/2.3,a/1.8,a/2.2,a/2.2),fboSonar.tex.toVP(sh_fx,{R:.5}),DMG.length&&(VIEWPORT(0,0,r,a),DBUFFER.update(DMG.map((t=>(t.t-=e,t.v[1]-=.5*e,ADD(t.p,t.p,t.v,.5*e),t.p))).flat()),DMG=DMG.filter((e=>e.t>0&&e.p[1]>PLY.dmg-.55-RAND(.2))),CAMERA([0,0,1],[0,0,0],UP,45,1,0,10),BLENDFUNC("A"),DRAW({pos:DBUFFER,0:DMG.length},0,{color:[.5,.55,.6,.2],psize:5,model:AMODEL},0)),PLY.open>0)for(PLY.dmg+=.01*e,i=0,l=RAND(10,10)*PLY.open;i<l;++i)ADDPART([-.3+RAND(.01),RAND(.01)+.4,0]);if(fbo.bind(0),fbo.tex.mips(),GLSET(BLEND,0),VIEWPORT(0,0,t,o),fbo.tex.toVP(sh_final,{time:GTIME,D:1.5*PLY.dmg-.3,V:PLY.life>.2?1:MAX(0,5*PLY.life)}),prevpos=V3(P),DEBUG?(KEYS.W&&ADD(P,P,front,50.5*e),KEYS.S&&ADD(P,P,front,50.5*-e),KEYS.E&&(PLY.pos[1]+=20.5*e),KEYS.Q&&(PLY.pos[1]-=20.5*e),KEYS.A&&(PLY.ang+=.75*e),KEYS.D&&(PLY.ang-=.75*e),KEYSP.F&&(PLY.spot=PLY.spot?0:2),KEYSP.Space&&(WPs.push([0|P[0],0|P[1],0|P[2]]),WPBUFFER=BUFFER(WPs.flat(),3)),KEYSP.Backspace&&(WPs.pop(),WPBUFFER=BUFFER(WPs.flat(),3)),KEYSP.P&&P.set(TRG)):!PLY.won&&PLY.life>0&&PLY.batt>0&&(KEYS.W&&(PLY.speed[2]+=25*e),KEYS.S&&(PLY.speed[2]-=25*e),KEYS.E&&(PLY.speed[1]+=10.5*e),KEYS.Q&&(PLY.speed[1]-=10.5*e),KEYS.A&&(PLY.speed[0]+=1.5*e),KEYS.D&&(PLY.speed[0]-=1.5*e),KEYSP.F&&(PLY.spot=PLY.spot?0:2),KEYSP.G&&PLY.open>0&&(PLY.open-=.05),KEYSP.R&&PLY.hasTRG&&(PLY.hasTRG=0,ADD(TRG,P,front,2.5)),KEYSP.Digit1&&(PLY.sonar=PLY.sonar?50==PLY.sonar?100:0:50),KEYSP.Digit2&&(PLY.scan=PLY.scan?0:1),KEYS.Space&&SCALE(PLY.speed,PLY.speed,.99)),KEYSP.Space&&(PLY.life<=0||PLY.won)&&(PLY.won&&(level=1),RESET()),PLY.ang+=e*PLY.speed[0]*.2,ADD(P,P,PLY.vel,e),SCALE(IMP,front,PLY.speed[2]),ADD(IMP,IMP,UP,PLY.speed[1]-10*PLY.dmg),ADD(PLY.vel,PLY.vel,IMP,e),SCALE(PLY.vel,PLY.vel,.95),PLY.speed[0]*=.99,PLY.speed[2]*=.99,PLY.speed[1]=CLAMP(PLY.speed[1],-16,16),PLY.batt-=e*(PLY.nrg=4+PLY.sonar/50+2*PLY.spot+PLY.speed[2]/10+2*PLY.scan)*1e-4,PLY.batt<=0&&(PLY.life-=.02*e,PLY.spot=0,PLY.sonar=0,PLY.nrg=0),PLY.dmg>=1&&(PLY.life-=.1*e),P[1]<10&&RAND()<.001&&(PLY.open=1),P[1]<8&&RAND()<.005&&(BREAKGLASS(),boom=1),isInside=0,INRANGE(P[0],0,WSIZE)&&INRANGE(P[1],0,HSIZE)&&INRANGE(P[2],0,WSIZE)&&(isInside|=GETW(P[0],P[1],P[2])),isInside&&!DEBUG){let e=LEN(PLY.vel);RAND()<.1&&(PLY.open=1),P.set(prevpos),SCALE(PLY.vel,PLY.vel,-.5),PLY.speed[2]=0,shake+=.01*e,e>2&&BREAKGLASS()}for(i=0;i<3;++i)P[i]=CLAMP(P[i],[5,1,5][i],[WSIZE-5,2*HSIZE+2,WSIZE-5][i]);SUB(totarget,TRG,P),totarget[1]=0,NORM(totarget,totarget),PLY.hasTRG=(TRGdist=DIST(TRG,P))<1.2,signal=SAT(1-.001*DIST(P,TRG))*POW(SAT(DOT(front,totarget)),4),SNK.dist=MIN(DIST(P,SNK.pos),DIST(P,SNK.part(10)),DIST(P,SNK.part(25)));let L=SNK.tail.d,R=SNK.pos,T=WPs[SNK.index];T||(WPs.reverse(),T=WPs[0],SNK.index=0),spark=RAND()<.008;let v=DIST(L,T);for(SUB(totarget,T,R),NORM(totarget,totarget),ADD(R,R,totarget,5*e),DIST(R,T)<2&&(SNK.index+=1),SNK.part(0).set(R),i=1;i<50;++i)R=ADD(V3(),SNK.part(i-1),[SIN(3*GTIME+i/5)/2,0,0],(i+1)/550),T=SNK.part(i),v=DIST(R,T),mind=(L[4*i-1]+L[4*i+3])/4,SUB(totarget,R,T),ADD(T,T,totarget,(v-mind)/v),L.set(T,4*i);SNK.tail.update(),SNK.dist<10&&spark&&(PLY.batt-=2*e,shake+=.1),batt=LERP(batt,PLY.batt,.01),shake*=.95,boom*=.8,!PLY.won&&P[1]>=170&&PLY.hasTRG&&(PLY.won=1,PLY.time=GTIME,DIV.style.fontSize=120),END(),MOUSE.buttons&&!ACX&&STARTAUDIO()},requestAnimationFrame(loop)</script>
